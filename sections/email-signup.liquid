{% comment %}
  Email Signup Section for Project-Dream theme
  Captures emails for marketing with conversion-focused design
{% endcomment %}

<div class="email-signup-section section-{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="email-signup-container">
    {% if section.settings.show_background_image and section.settings.background_image %}
      <div class="email-signup-background">
        {% render 'image', 
          image: section.settings.background_image,
          class: 'background-image',
          loading: 'lazy',
          sizes: '100vw'
        %}
      </div>
    {% endif %}

    <div class="email-signup-content">
      {% if section.settings.heading != blank %}
        <h2 class="email-signup-heading">{{ section.settings.heading }}</h2>
      {% endif %}

      {% if section.settings.subheading != blank %}
        <p class="email-signup-subheading">{{ section.settings.subheading }}</p>
      {% endif %}

      {% if section.settings.show_benefits %}
        <div class="email-signup-benefits">
          {% for i in (1..3) %}
            {% assign benefit_key = 'benefit_' | append: i %}
            {% assign benefit_text = section.settings[benefit_key] %}
            {% if benefit_text != blank %}
              <div class="benefit-item">
                <span class="benefit-icon">{{ section.settings.benefit_icon | default: '✓' }}</span>
                <span class="benefit-text">{{ benefit_text }}</span>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <form 
        action="/contact#newsletter"
        method="post"
        class="email-signup-form"
        data-newsletter-form
        novalidate
      >
        <input type="hidden" name="form_type" value="customer">
        <input type="hidden" name="utf8" value="✓">
        <input type="hidden" name="contact[tags]" value="newsletter">

        <div class="form-group">
          <div class="form-fields">
            {% if section.settings.show_name_field %}
              <div class="form-field">
                <label for="newsletter-name-{{ section.id }}" class="sr-only">
                  {{ 'general.newsletter.name' | t }}
                </label>
                <input
                  type="text"
                  id="newsletter-name-{{ section.id }}"
                  name="contact[first_name]"
                  placeholder="{{ section.settings.name_placeholder | default: 'First name' }}"
                  class="form-input"
                  autocomplete="given-name"
                >
              </div>
            {% endif %}

            <div class="form-field email-field">
              <label for="newsletter-email-{{ section.id }}" class="sr-only">
                {{ 'general.newsletter.email' | t }}
              </label>
              <input
                type="email"
                id="newsletter-email-{{ section.id }}"
                name="contact[email]"
                placeholder="{{ section.settings.email_placeholder | default: 'Enter your email' }}"
                class="form-input"
                required
                autocomplete="email"
              >
            </div>

            <button type="submit" class="btn btn-primary newsletter-submit">
              {{ section.settings.button_text | default: 'Subscribe' }}
            </button>
          </div>

          {% if section.settings.show_discount %}
            <div class="discount-offer">
              <span class="discount-text">{{ section.settings.discount_text | default: 'Get 10% off your first order!' }}</span>
            </div>
          {% endif %}
        </div>

        {% if section.settings.show_privacy_note %}
          <div class="privacy-note">
            <small>{{ section.settings.privacy_text | default: 'We respect your privacy. Unsubscribe at any time.' }}</small>
          </div>
        {% endif %}

        <div class="form-messages">
          <div class="success-message" style="display: none;">
            {{ section.settings.success_message | default: 'Thank you for subscribing!' }}
          </div>
          <div class="error-message" style="display: none;">
            {{ section.settings.error_message | default: 'Please enter a valid email address.' }}
          </div>
        </div>
      </form>

      {% if section.settings.show_social_proof and section.settings.subscriber_count != blank %}
        <div class="social-proof">
          <span class="subscriber-count">{{ section.settings.subscriber_count | plus: 0 | default: 1000 }}+ subscribers</span>
          <span class="social-proof-text">{{ section.settings.social_proof_text | default: 'Join our community' }}</span>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% stylesheet %}
  .email-signup-section {
    position: relative;
    padding: var(--space-xl) var(--mobile-padding);
    overflow: hidden;
  }

  .email-signup-container {
    position: relative;
    max-width: var(--page-width);
    margin: 0 auto;
    text-align: center;
  }

  .email-signup-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
  }

  .background-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.1;
  }

  .email-signup-content {
    position: relative;
    z-index: 1;
    max-width: 600px;
    margin: 0 auto;
  }

  .email-signup-heading {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    font-family: var(--font-family-heading);
    margin-bottom: var(--space-sm);
    color: var(--color-foreground);
  }

  .email-signup-subheading {
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-lg);
    line-height: 1.4;
  }

  .email-signup-benefits {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    text-align: left;
  }

  .benefit-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .benefit-icon {
    color: var(--color-success);
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-lg);
  }

  .benefit-text {
    font-size: var(--font-size-base);
    color: var(--color-foreground);
  }

  .email-signup-form {
    margin-bottom: var(--space-lg);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .form-fields {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .form-field {
    flex: 1;
  }

  .form-input {
    width: 100%;
    padding: var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    font-size: var(--font-size-base);
    font-family: var(--font-family-body);
    background-color: var(--color-background);
    color: var(--color-foreground);
    transition: border-color var(--transition-fast);
    min-height: var(--mobile-button-height);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(var(--color-primary), 0.2);
  }

  .form-input::placeholder {
    color: var(--color-text-secondary);
  }

  .newsletter-submit {
    width: 100%;
    min-height: var(--mobile-button-height);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-bold);
    border-radius: var(--button-border-radius);
    transition: all var(--transition-fast);
  }

  .discount-offer {
    padding: var(--space-sm);
    background-color: var(--color-accent);
    color: white;
    border-radius: var(--border-radius);
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-sm);
  }

  .privacy-note {
    margin-top: var(--space-sm);
    color: var(--color-text-secondary);
    font-size: var(--font-size-xs);
    line-height: 1.4;
  }

  .form-messages {
    margin-top: var(--space-sm);
  }

  .success-message {
    color: var(--color-success);
    font-weight: var(--font-weight-medium);
    padding: var(--space-sm);
    background-color: rgba(var(--color-success), 0.1);
    border-radius: var(--border-radius);
    border: 1px solid rgba(var(--color-success), 0.2);
  }

  .error-message {
    color: var(--color-error);
    font-weight: var(--font-weight-medium);
    padding: var(--space-sm);
    background-color: rgba(var(--color-error), 0.1);
    border-radius: var(--border-radius);
    border: 1px solid rgba(var(--color-error), 0.2);
  }

  .social-proof {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-md);
    background-color: var(--color-background-secondary);
    border-radius: var(--border-radius);
    border: 1px solid var(--color-border);
  }

  .subscriber-count {
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-lg);
    color: var(--color-primary);
  }

  .social-proof-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Style variations */
  .email-signup-section[data-style="minimal"] {
    background-color: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
  }

  .email-signup-section[data-style="filled"] {
    background-color: var(--color-background-secondary);
  }

  .email-signup-section[data-style="gradient"] {
    background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
    color: white;
  }

  .email-signup-section[data-style="gradient"] .email-signup-heading,
  .email-signup-section[data-style="gradient"] .email-signup-subheading,
  .email-signup-section[data-style="gradient"] .benefit-text {
    color: white;
  }

  .email-signup-section[data-style="gradient"] .form-input {
    background-color: rgba(255, 255, 255, 0.9);
  }

  /* Responsive design */
  @media (min-width: 640px) {
    .email-signup-benefits {
      flex-direction: row;
      justify-content: center;
      text-align: center;
    }

    .benefit-item {
      flex-direction: column;
      text-align: center;
      gap: var(--space-xs);
    }
  }

  @media (min-width: 768px) {
    .email-signup-section {
      padding: var(--space-2xl) var(--page-margin);
    }

    .form-fields {
      flex-direction: row;
      align-items: flex-end;
    }

    .newsletter-submit {
      width: auto;
      min-width: 140px;
      flex-shrink: 0;
    }

    .social-proof {
      flex-direction: row;
      justify-content: center;
    }
  }

  @media (min-width: 1024px) {
    .email-signup-section {
      padding: var(--space-3xl) var(--page-margin);
    }

    .email-signup-heading {
      font-size: var(--font-size-3xl);
    }
  }
{% endstylesheet %}

{% javascript %}
  class EmailSignupSection extends HTMLElement {
    constructor() {
      super();
      this.form = this.querySelector('[data-newsletter-form]');
      this.successMessage = this.querySelector('.success-message');
      this.errorMessage = this.querySelector('.error-message');
      
      this.init();
    }

    init() {
      if (this.form) {
        this.form.addEventListener('submit', this.handleSubmit.bind(this));
      }
    }

    async handleSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(this.form);
      const email = formData.get('contact[email]');
      
      // Basic email validation
      if (!this.isValidEmail(email)) {
        this.showError('Please enter a valid email address.');
        return;
      }

      // Disable submit button during submission
      const submitButton = this.form.querySelector('.newsletter-submit');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'Subscribing...';

      try {
        const response = await fetch('/contact', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          this.showSuccess();
          this.form.reset();
          
          // Track conversion event
          if (typeof gtag !== 'undefined') {
            gtag('event', 'newsletter_signup', {
              event_category: 'engagement',
              event_label: 'email_signup_section'
            });
          }
          
          // Dispatch custom event for other integrations
          document.dispatchEvent(new CustomEvent('newsletter:signup', {
            detail: { email: email }
          }));
        } else {
          throw new Error('Subscription failed');
        }
      } catch (error) {
        console.error('Newsletter signup error:', error);
        this.showError('Something went wrong. Please try again.');
      } finally {
        // Re-enable submit button
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    }

    isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    showSuccess() {
      this.hideMessages();
      this.successMessage.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        this.successMessage.style.display = 'none';
      }, 5000);
    }

    showError(message) {
      this.hideMessages();
      this.errorMessage.textContent = message;
      this.errorMessage.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        this.errorMessage.style.display = 'none';
      }, 5000);
    }

    hideMessages() {
      this.successMessage.style.display = 'none';
      this.errorMessage.style.display = 'none';
    }
  }

  customElements.define('email-signup-section', EmailSignupSection);
{% endjavascript %}

{% schema %}
{
  "name": "Email Signup",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Stay in the loop"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "Subscribe to our newsletter for exclusive offers and updates."
    },
    {
      "type": "header",
      "content": "Benefits"
    },
    {
      "type": "checkbox",
      "id": "show_benefits",
      "label": "Show benefits",
      "default": true
    },
    {
      "type": "text",
      "id": "benefit_icon",
      "label": "Benefit icon",
      "default": "✓",
      "info": "Emoji or symbol to display next to each benefit"
    },
    {
      "type": "text",
      "id": "benefit_1",
      "label": "Benefit 1",
      "default": "Exclusive discounts"
    },
    {
      "type": "text",
      "id": "benefit_2",
      "label": "Benefit 2",
      "default": "New arrivals first"
    },
    {
      "type": "text",
      "id": "benefit_3",
      "label": "Benefit 3",
      "default": "Style tips & trends"
    },
    {
      "type": "header",
      "content": "Form Settings"
    },
    {
      "type": "checkbox",
      "id": "show_name_field",
      "label": "Show name field",
      "default": false
    },
    {
      "type": "text",
      "id": "name_placeholder",
      "label": "Name placeholder",
      "default": "First name"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Subscribe"
    },
    {
      "type": "header",
      "content": "Discount Offer"
    },
    {
      "type": "checkbox",
      "id": "show_discount",
      "label": "Show discount offer",
      "default": true
    },
    {
      "type": "text",
      "id": "discount_text",
      "label": "Discount text",
      "default": "Get 10% off your first order!"
    },
    {
      "type": "header",
      "content": "Privacy & Messages"
    },
    {
      "type": "checkbox",
      "id": "show_privacy_note",
      "label": "Show privacy note",
      "default": true
    },
    {
      "type": "text",
      "id": "privacy_text",
      "label": "Privacy note",
      "default": "We respect your privacy. Unsubscribe at any time."
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success message",
      "default": "Thank you for subscribing!"
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Error message",
      "default": "Please enter a valid email address."
    },
    {
      "type": "header",
      "content": "Social Proof"
    },
    {
      "type": "checkbox",
      "id": "show_social_proof",
      "label": "Show social proof",
      "default": true
    },
    {
      "type": "text",
      "id": "subscriber_count",
      "label": "Subscriber count",
      "default": "5000",
      "info": "Number of current subscribers"
    },
    {
      "type": "text",
      "id": "social_proof_text",
      "label": "Social proof text",
      "default": "Join our community"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "select",
      "id": "section_style",
      "label": "Section style",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "minimal",
          "label": "Minimal"
        },
        {
          "value": "filled",
          "label": "Filled background"
        },
        {
          "value": "gradient",
          "label": "Gradient background"
        }
      ],
      "default": "default"
    },
    {
      "type": "checkbox",
      "id": "show_background_image",
      "label": "Show background image",
      "default": false
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background image"
    }
  ],
  "presets": [
    {
      "name": "Email Signup",
      "settings": {
        "heading": "Stay in the loop",
        "subheading": "Subscribe to our newsletter for exclusive offers and updates.",
        "show_benefits": true,
        "show_discount": true,
        "show_social_proof": true
      }
    }
  ]
}
{% endschema %}